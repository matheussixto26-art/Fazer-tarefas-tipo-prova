<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Eclipse | Diagnóstico de Tarefas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #010409; }
        .background-eclipse { background-image: url('https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?auto=format&fit=crop'); background-size: cover; background-position: center; }
        .glass-effect { background: rgba(23, 27, 38, 0.8); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .task-list-container { max-height: 40vh; overflow-y: auto; }
        .task-item { cursor: pointer; }
        .task-item.selected { background-color: #25b0e8; color: #010409; }
        #log-output { white-space: pre-wrap; word-wrap: break-word; max-height: 400px; overflow-y: auto; font-size: 0.8rem; }
        .log-title { color: #25b0e8; font-weight: bold; }
        .log-error { color: #e886a3; }
    </style>
</head>
<body class="background-eclipse text-white">
    <div class="relative min-h-screen w-full flex flex-col items-center justify-center p-4">
        <header class="absolute top-0 left-0 w-full p-6"><h1 class="text-2xl font-bold tracking-wider">eclipse | diagnóstico</h1></header>
        <div class="w-full max-w-3xl glass-effect p-8 rounded-2xl shadow-lg">
            <div id="login-view">
                <form id="login-form" class="space-y-4">
                    <input type="text" id="ra-input" placeholder="RA" class="w-full px-4 py-3 bg-gray-800/50 border border-gray-600 rounded-lg" required>
                    <input type="password" id="senha-input" placeholder="Senha" class="w-full px-4 py-3 bg-gray-800/50 border border-gray-600 rounded-lg" required>
                    <button id="login-button" type="submit" class="w-full py-3 bg-cyan-500 font-semibold rounded-lg">1. Buscar Todas as Atividades</button>
                </form>
                <p id="login-message" class="text-red-400 text-sm mt-4 min-h-[20px]"></p>
            </div>
            <div id="tasks-view" class="hidden">
                <h2 class="text-2xl font-bold mb-4">2. Selecione a Tarefa para Diagnosticar</h2>
                <div id="task-list" class="space-y-2 mb-4 task-list-container border border-gray-700 rounded-lg p-2"></div>
                <button id="start-diag-btn" class="w-full py-3 bg-purple-500 font-semibold rounded-lg disabled:bg-gray-600" disabled>3. Iniciar Diagnóstico</button>
            </div>
            <div id="log-view" class="mt-6 hidden">
                <h3 class="text-xl font-bold mb-2">Log de Execução</h3>
                <div id="log-output" class="bg-black/50 p-4 rounded-lg"></div>
            </div>
        </div>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const appState = { data: null, tokenB: null, selectedTask: null };
        const ui = {
            loginView: document.getElementById('login-view'), tasksView: document.getElementById('tasks-view'),
            logView: document.getElementById('log-view'), loginForm: document.getElementById('login-form'),
            raInput: document.getElementById('ra-input'), senhaInput: document.getElementById('senha-input'),
            loginButton: document.getElementById('login-button'), loginMessage: document.getElementById('login-message'),
            taskList: document.getElementById('task-list'), startDiagBtn: document.getElementById('start-diag-btn'),
            logOutput: document.getElementById('log-output'),
        };

        const logToPage = (title, data, isError = false) => {
            const entry = document.createElement('div');
            entry.innerHTML = `<p class="${isError ? 'log-error' : 'log-title'}">[${new Date().toLocaleTimeString()}] ${title}</p>${data ? `<pre>${JSON.stringify(data, null, 2)}</pre>` : ''}`;
            ui.logOutput.prepend(entry);
        };

        ui.loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            ui.loginButton.disabled = true; ui.loginButton.textContent = 'A Buscar...'; ui.loginMessage.textContent = '';
            try {
                const response = await fetch('/api/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ user: ui.raInput.value, senha: ui.senhaInput.value }) });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Falha no login');
                appState.data = data; appState.tokenB = data.tokenB;
                populateTaskList();
                ui.loginView.classList.add('hidden'); ui.tasksView.classList.remove('hidden');
            } catch (error) { ui.loginMessage.textContent = `❌ ${error.message}`;
            } finally { ui.loginButton.disabled = false; ui.loginButton.textContent = '1. Buscar Todas as Atividades'; }
        });

        function populateTaskList() {
            ui.taskList.innerHTML = '';
            const tasksToDisplay = appState.data.tarefas?.filter(t => t.answer_status !== 'submitted');
            if (!tasksToDisplay || tasksToDisplay.length === 0) { ui.taskList.innerHTML = '<p>Nenhuma tarefa encontrada.</p>'; return; }
            tasksToDisplay.forEach(task => {
                const taskElement = document.createElement('div');
                taskElement.className = 'task-item p-3 rounded-md hover:bg-gray-700';
                taskElement.textContent = `[ID: ${task.id}] ${task.title}`;
                taskElement.dataset.taskId = task.id;
                taskElement.addEventListener('click', () => {
                    appState.selectedTask = task;
                    ui.startDiagBtn.disabled = false;
                    document.querySelectorAll('.task-item').forEach(el => el.classList.remove('selected'));
                    taskElement.classList.add('selected');
                });
                ui.taskList.appendChild(taskElement);
            });
        }
        
        ui.startDiagBtn.addEventListener('click', async () => {
            if (!appState.selectedTask) { alert("Selecione uma tarefa!"); return; }
            ui.startDiagBtn.disabled = true; ui.logView.classList.remove('hidden'); ui.logOutput.innerHTML = '';
            const taskData = appState.selectedTask;
            try {
                logToPage("PASSO 1: OBTENDO GABARITO...");
                const getAnswersPayload = { taskId: taskData.id, tokenB: appState.tokenB, room: findCorrectRoomId(taskData) };
                logToPage("Enviando para /api/obter-respostas:", getAnswersPayload);
                const answersResponse = await fetch('/api/obter-respostas', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(getAnswersPayload) });
                const answersData = await answersResponse.json();
                if (!answersResponse.ok) throw new Error(`Falha ao obter gabarito: ${JSON.stringify(answersData)}`);
                logToPage("Resposta do gabarito (sucesso):", answersData);

                logToPage("PASSO 2: ENVIANDO RESPOSTAS...");
                const duration = (Math.random() * 210 + 90).toFixed(2);
                const officialPayload = { status: 'submitted', answers: answersData.answers, accessed_on: "room", executed_on: findCorrectRoomId(taskData), duration: parseFloat(duration) };
                logToPage("Enviando para /api/enviar-tarefa:", { taskId: taskData.id, payload: officialPayload });
                const submitResponse = await fetch('/api/enviar-tarefa', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ taskId: taskData.id, tokenB: appState.tokenB, payload: officialPayload }) });
                const submitData = await submitResponse.json();
                if (!submitResponse.ok) throw new Error(`Falha ao submeter tarefa: ${JSON.stringify(submitData)}`);
                logToPage("Resposta da submissão (sucesso):", submitData);

            } catch (error) {
                logToPage("!!! PROCESSO FALHOU !!!", { message: error.message }, true);
            } finally {
                ui.startDiagBtn.disabled = false;
            }
        });

        function findCorrectRoomId(taskData) {
            const taskTarget = String(taskData.publication_target);
            if (taskTarget.startsWith('r')) return taskTarget;
            if (!appState.data.rooms) return taskTarget;
            for (const room of appState.data.rooms) {
                const groupIds = room.group_categories?.map(g => String(g.id)) || [];
                if (groupIds.includes(taskTarget)) { return room.publication_target; }
            }
            return taskTarget;
        }
    });
    </script>
</body>
</html>
